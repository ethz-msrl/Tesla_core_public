name: main

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build_and_test:
    strategy:
        matrix:
            ros_distro: [melodic]
            include:
                - ros_distro: melodic
                  os: ubuntu-18.04
        fail-fast: false

    runs-on: ${{ matrix.os }}
    env:
      ROS_DISTRO: ${{ matrix.ros_distro }}
      ROS_CI_DESKTOP: "`lsb_release -cs`"  # e.g. [trusty|xenial|...]
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.8.0
        with:
          access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v2
        with:
          lfs: true
      - name: Install ROS
        run: |
          sudo sh -c "echo \"deb http://packages.ros.org/ros/ubuntu $ROS_CI_DESKTOP main\" > /etc/apt/sources.list.d/ros-latest.list"
          sudo apt-key adv --keyserver 'hkp://keyserver.ubuntu.com:80' --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654
          sudo apt-get update -qq
          sudo apt-get install dpkg
          sudo apt-get install -y python-catkin-tools python-rosdep python-wstool ros-$ROS_DISTRO-ros-base
          source /opt/ros/$ROS_DISTRO/setup.bash
          # Prepare rosdep to install dependencies.
          sudo rosdep init
          rosdep update --include-eol-distros  # Support EOL distros.
      - name: Install Dependencies
        run: sudo apt update && sudo apt install swig libyaml-cpp-dev libeigen3-dev -y
      - name: Link Source
        run: | 
          mkdir -p ~/tc_ws/src
          ln -s $GITHUB_WORKSPACE ~/tc_ws/src/Tesla_core
      - name: Create Workspace
        run: |
          cd ~/tc_ws
          catkin init --workspace .
          catkin config --extend /opt/ros/$ROS_DISTRO
          catkin config --cmake-args -DCMAKE_BUILD_TYPE=Release
          cd src
      - name: Inject rosinstall credentials
        run: |
            sed -i 's|git@github\.com:|https://${{ secrets.NAVION_MSRL_READ_TOKEN }}@github\.com/|g' dependencies.rosinstall
      - name: Rosinstall deps   
        run: |
          cd ~/tc_ws/src
          wstool init
          wstool merge Tesla_core/dependencies.rosinstall
          wstool update
      - name: Rosdep install
        run: |
            cd ~/tc_ws
            rosdep install --from-paths src --ignore-src -r -y
      - name: Catkin Build
        run: |
            cd ~/tc_ws
            catkin build -j 8 -l 8 --no-status --summarize
      - name: Run Tests
        run: |
            cd ~/tc_ws
            source ~/tc_ws/devel/setup.bash
            catkin run_tests
            catkin_test_results --verbose
  build_and_test_noetic:
    runs-on: ubuntu-20.04
    env:
      ROS_DISTRO: noetic
      ROS_CI_DESKTOP: "`lsb_release -cs`"  # e.g. [trusty|xenial|...]
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.8.0
        with:
          access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v2
        with:
          lfs: true
      - name: Install ROS
        run: |
          sudo sh -c "echo \"deb http://packages.ros.org/ros/ubuntu $ROS_CI_DESKTOP main\" > /etc/apt/sources.list.d/ros-latest.list"
          sudo apt-key adv --keyserver 'hkp://keyserver.ubuntu.com:80' --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654
          sudo apt-get update -qq
          sudo apt-get install dpkg
          sudo apt-get install -y python3-catkin-tools python3-rosdep python3-wstool ros-$ROS_DISTRO-ros-base
          sudo apt install -y python3-catkin-lint python3-pip
          sudo pip3 install osrf-pycommon
          source /opt/ros/$ROS_DISTRO/setup.bash
          # Prepare rosdep to install dependencies.
          sudo rosdep init
          rosdep update --include-eol-distros  # Support EOL distros.
      - name: Install Dependencies
        run: sudo apt update && sudo apt install swig libyaml-cpp-dev libeigen3-dev -y
      - name: Link Source
        run: | 
          mkdir -p ~/tc_ws/src
          ln -s $GITHUB_WORKSPACE ~/tc_ws/src/Tesla_core
      - name: Create Workspace
        run: |
          cd ~/tc_ws
          catkin init --workspace .
          catkin config --extend /opt/ros/$ROS_DISTRO
          catkin config --cmake-args -DCMAKE_BUILD_TYPE=Release
          cd src
      - name: Inject rosinstall credentials
        run: |
            sed -i 's|git@github\.com:|https://${{ secrets.NAVION_MSRL_READ_TOKEN }}@github\.com/|g' dependencies.rosinstall
      - name: Rosinstall deps   
        run: |
          cd ~/tc_ws/src
          wstool init
          wstool merge Tesla_core/dependencies.rosinstall
          wstool update
      - name: Rosdep install
        run: |
            cd ~/tc_ws
            rosdep install --from-paths src --ignore-src -r -y
      - name: Catkin Build
        run: |
            cd ~/tc_ws
            catkin build -j 8 -l 8 --no-status --summarize
      - name: Run Tests
        run: |
            cd ~/tc_ws
            source ~/tc_ws/devel/setup.bash
            catkin run_tests
            catkin_test_results --verbose


  build_and_test_install:
    runs-on: ubuntu-18.04
    env:
      ROS_DISTRO: melodic
      ROS_CI_DESKTOP: "`lsb_release -cs`"  # e.g. [trusty|xenial|...]
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.8.0
        with:
          access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v2
        with:
          lfs: true
      - name: Install ROS
        run: |
          sudo sh -c "echo \"deb http://packages.ros.org/ros/ubuntu $ROS_CI_DESKTOP main\" > /etc/apt/sources.list.d/ros-latest.list"
          sudo apt-key adv --keyserver 'hkp://keyserver.ubuntu.com:80' --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654
          sudo apt-get update -qq
          sudo apt-get install dpkg
          sudo apt-get install -y python-catkin-tools python-rosdep python-wstool ros-$ROS_DISTRO-ros-base
          source /opt/ros/$ROS_DISTRO/setup.bash
          # Prepare rosdep to install dependencies.
          sudo rosdep init
          rosdep update --include-eol-distros  # Support EOL distros.
      - name: Install Dependencies
        run: sudo apt update && sudo apt install swig libyaml-cpp-dev libeigen3-dev -y
      - name: Link Source
        run: | 
          mkdir -p ~/tc_ws/src
          ln -s $GITHUB_WORKSPACE ~/tc_ws/src/Tesla_core
      - name: Create Workspace
        run: |
          cd ~/tc_ws
          catkin init --workspace .
          catkin config --extend /opt/ros/$ROS_DISTRO
          catkin config --cmake-args -DCMAKE_BUILD_TYPE=Release
          catkin config --install
          cd src
      - name: Inject rosinstall credentials
        run: |
            sed -i 's|git@github\.com:|https://${{ secrets.NAVION_MSRL_READ_TOKEN }}@github\.com/|g' dependencies.rosinstall
      - name: Rosinstall deps   
        run: |
          cd ~/tc_ws/src
          wstool init
          wstool merge Tesla_core/dependencies.rosinstall
          wstool update
      - name: Rosdep install
        run: |
            cd ~/tc_ws
            rosdep install --from-paths src --ignore-src -r -y
      - name: Catkin Build
        run: |
            cd ~/tc_ws
            catkin build -j 8 -l 8 --no-status --summarize
      - name: Run Tests
        run: |
            cd ~/tc_ws
            source ~/tc_ws/install/setup.bash
            catkin run_tests
            catkin_test_results --verbose
